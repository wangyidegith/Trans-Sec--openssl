零 整体：看图片







一 每次握手都发了什么信息
（零）第一次握手
0 客户端发送一个 ClientHello 消息，包含以下信息：
（0）支持的 TLS 版本。
（1）支持的加密套件（cipher suites）。
（2）支持的压缩方法。
（3）生成的随机数（random nonce）。
（4）可选的扩展信息（如服务器名称指示 SNI）。



（一）第二次握手
0 服务器响应一个 ServerHello 消息，包含以下信息:
（0）选择的 TLS 版本。
（1）选择的加密套件。
（2）选择的压缩方法。
（3）生成的随机数（random nonce）。
（4）其他的扩展信息。

1 cert：服务器证书和中间证书，总之就是一个证书链。

2 ServerHelloDone
服务器发送 ServerHelloDone 消息，表示服务器的消息已发送完毕，等待客户端响应。
注意：没有ClientHelloDone。

# 上面两个是必选项，下面是可选项

2 ServerKeyExchange（可选）：如果选择的加密套件需要额外的密钥交换信息（比如使用 Diffie-Hellman 或 ECDHE），服务器将发送 ServerKeyExchange 消息，包含所需的参数。

3 CertificateRequest（可选）
如果服务器希望客户端提供证书进行身份验证，它会发送 CertificateRequest 消息，要求客户端发送其证书。

4 我曾经对第二次握手产生过很长一段时间的误解：我以为第二次握手会发送一个使用服务器证书对应的私钥的签名以让客户端验证服务器的身份，但是这怎么能验证身份呢？如果一个钓鱼网站采用了自签证书一样可以使用私钥进行签名，所以这个签名是完全没有必要的，验证服务器身份靠的是证书验证。



# 第二次握手和第三次握手之间，客户端会做证书验证。



（二）第三次握手
0 ClientKeyExchange
客户端生成一个随机数（称为 pre-master secret），并使用服务器的公钥加密后发送给服务器。这一随机数将用于生成会话密钥。

1 ChangeCipherSpec
客户端发送 ChangeCipherSpec 消息，告知服务器后续的消息将使用刚刚协商的加密算法和密钥加密。

2 Finished
客户端发送 Finished 消息，包含对之前所有握手消息的哈希，加密后发送给服务器，表明握手完成。

3 cert：取决于服务器是否要求发送证书（可选）。



（三）第四次握手
0 ChangeCipherSpec
服务器接收到客户端的 Finished 消息后，发送自己的 ChangeCipherSpec 消息，表示接下来会使用协商的算法和密钥。

1 服务器的 Finished
服务器也发送 Finished 消息，确认握手完成。

